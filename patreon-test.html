<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Gating Example</title>
   <script>
    const clientId = 'pt8PQIzv9ECrXxWtnKEByZhyWZjOcmuDGmZDyxswQM0n4ij83k2jkk-6LA9Ztrcr';
        const redirectUri = 'https://chrishutchins.github.io/patreon-test.html';

        
        document.getElementById('login-button').addEventListener('click', () => {
            const authUrl = `https://www.patreon.com/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=identity`;
            window.location.href = authUrl;
        });

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function exchangeCodeForToken(code) {
            try {
                const response = await fetch('https://www.patreon.com/api/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: clientId,
                        client_secret: 'pNIdyTNWbBXZ3vOq05ErfNW9ARPt11FIlaQHbrDvc6ZYYX8-cy_eW3UvbBsy-xsd',
                        redirect_uri: redirectUri,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Token exchange successful:', data);
                return data.access_token;
            } catch (error) {
                console.error('Error exchanging code for token:', error);
            }
        }

        async function getUserInfo(token) {
            try {
                const response = await fetch('https://www.patreon.com/api/oauth2/v2/identity', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('User info retrieved:', data);
                return data;
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        (async () => {
            const code = getQueryParam('code');
            if (code) {
                try {
                    const token = await exchangeCodeForToken(code);
                    if (token) {
                        const userInfo = await getUserInfo(token);
                        if (userInfo) {
                            document.getElementById('content-not-authenticated').style.display = 'none';
                            document.getElementById('content-authenticated').style.display = 'block';
                        } else {
                            console.error('No user info retrieved.');
                        }
                    } else {
                        console.error('No token retrieved.');
                    }
                } catch (error) {
                    console.error('Error during OAuth process:', error);
                }
            }
        })();

</script>
</head>
<body>
    <h1>Patreon</h1>
    <div id="content-not-authenticated">
<p>Please log in with Patreon to view this content.</p>
<button id="login-button">Log in with Patreon</button></div>
<div id="content-authenticated" style="display: none;">
<p>Welcome, patron! Here is your exclusive content:</p>
<!-- Your gated content goes here --></div>
</body>
</html>
